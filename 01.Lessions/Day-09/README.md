# Day 9


## üíõ Session 16 - Enhancements in SQL Server 2019

Xem link: https://learn.microsoft.com/en-us/sql/sql-server/what-s-new-in-sql-server-2019?view=sql-server-ver16

### üí• Verbose Truncation Warnings

Kh√°i ni·ªám "Verbose Truncation Warnings" c√≥ th·ªÉ ƒë∆∞·ª£c hi·ªÉu l√† m·ªôt c√°ch th·ª©c ho·∫°t ƒë·ªông ho·∫∑c m·ªôt t√≠nh nƒÉng trong vi·ªác c·∫Øt gi·∫£m (truncation) th√¥ng b√°o d√†i hay chi ti·∫øt (verbose warnings) trong l·∫≠p tr√¨nh ho·∫∑c c√°c ng√¥n ng·ªØ l·∫≠p tr√¨nh.

```sql
CREATE TABLE [dbo].[tbl_Color](
    [Color ID] [int] IDENTITY(1,1) NOT NULL,
    [Color Name] [varchar](3) NULL
) ON [PRIMARY]
GO
 
INSERT INTO [dbo].[tbl_Color]
           ([Color Name])
     VALUES
           ('Red'),
           ('Blue'), -- V∆∞·ª£t qu√° ƒë·ªô d√†i ƒë√£ khai b√°o
           ('Green') --
GO
```

==> Khi ch·∫°y l√™nh tr√™n b·∫°n s·∫Ω SQL Server 2019 b√°o l·ªói c√°nh b√°o ƒë·ªô d√†i d·ªØ li·ªáu v∆∞·ª£t qu√° c·∫•u tr√∫c d·ªØ li·ªáu ƒë√£ khai b√°o.



### üí• Verbose Truncation Warnings

Vulnerability Assessment (ƒë√°nh gi√° l·ªó h·ªïng) l√† qu√° tr√¨nh x√°c ƒë·ªãnh, ƒë√°nh gi√° v√† ƒëo l∆∞·ªùng c√°c l·ªó h·ªïng b·∫£o m·∫≠t trong h·ªá th·ªëng, m·∫°ng, ·ª©ng d·ª•ng ho·∫∑c c√¥ng ngh·ªá th√¥ng tin. M·ª•c ti√™u c·ªßa Vulnerability Assessment l√† t√¨m ra c√°c ƒëi·ªÉm y·∫øu v√† l·ªó h·ªïng trong h·ªá th·ªëng v√† ƒë∆∞a ra c√°c khuy·∫øn ngh·ªã v·ªÅ bi·ªán ph√°p b·∫£o m·∫≠t ƒë·ªÉ gi·∫£m thi·ªÉu nguy c∆° x√¢m nh·∫≠p ho·∫∑c t·∫•n c√¥ng.


Click ph·∫£i l√™n `Database` c·ªßa b·∫°n, sau ƒë√≥ ch·ªçn `Tasks` --> `Ch·ªçn Vulnerability assessment` =>  `Scan for Vulnerabilities`...


![](https://learn.microsoft.com/en-us/sql/relational-databases/security/media/sql-vulnerability-assessment/1-ssmsgetstarted.png?view=sql-server-ver16)

Qu√©t xong b·∫°n s·∫Ω nh·∫≠n ƒë∆∞·ª£c m·ªôt b√°o c√°o

![ds](https://learn.microsoft.com/en-us/sql/relational-databases/security/media/sql-vulnerability-assessment/3-ssmsscanresults.png?view=sql-server-ver16)

Chi ti·∫øt xem: https://learn.microsoft.com/en-us/sql/relational-databases/security/sql-vulnerability-assessment?view=sql-server-ver16

### üí• Big Data Clusters

Big Data Clusters trong SQL Server l√† m·ªôt t√≠nh nƒÉng m·ªõi ƒë∆∞·ª£c gi·ªõi thi·ªáu t·ª´ phi√™n b·∫£n SQL Server 2019. N√≥ cung c·∫•p kh·∫£ nƒÉng t√≠ch h·ª£p v√† qu·∫£n l√Ω d·ªØ li·ªáu l·ªõn (big data) t·ª´ nhi·ªÅu ngu·ªìn kh√°c nhau trong m·ªôt m√¥i tr∆∞·ªùng SQL Server duy nh·∫•t.

Big Data Clusters cho ph√©p ng∆∞·ªùi d√πng l∆∞u tr·ªØ v√† truy v·∫•n d·ªØ li·ªáu t·ª´ c√°c ngu·ªìn b√™n ngo√†i, ch·∫≥ng h·∫°n nh∆∞ d·ªØ li·ªáu Hadoop, Apache Spark, v√† d·ªØ li·ªáu c√≥ c·∫•u tr√∫c kh√°c. N√≥ cung c·∫•p m·ªôt l·ªõp tr·ª´u t∆∞·ª£ng tr√™n d·ªØ li·ªáu Big Data, cho ph√©p ng∆∞·ªùi d√πng truy v·∫•n v√† x·ª≠ l√Ω d·ªØ li·ªáu l·ªõn b·∫±ng c√°ch s·ª≠ d·ª•ng ng√¥n ng·ªØ truy v·∫•n SQL quen thu·ªôc.

Big Data Clusters trong SQL Server c≈©ng cung c·∫•p t√≠nh nƒÉng Scale-Out, cho ph√©p m·ªü r·ªông ngang d·ªØ li·ªáu v√† c√¥ng vi·ªác x·ª≠ l√Ω tr√™n nhi·ªÅu n√∫t (nodes) trong m·ªôt c·ª•m (cluster). ƒêi·ªÅu n√†y gi√∫p tƒÉng kh·∫£ nƒÉng x·ª≠ l√Ω v√† hi·ªáu su·∫•t khi l√†m vi·ªác v·ªõi d·ªØ li·ªáu l·ªõn.


### üí• JSON Data

JSON (JavaScript Object Notation) l√† m·ªôt ƒë·ªãnh d·∫°ng d·ªØ li·ªáu ph·ªï bi·∫øn ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ truy·ªÅn v√† l∆∞u tr·ªØ d·ªØ li·ªáu c√≥ c·∫•u tr√∫c. SQL Server h·ªó tr·ª£ l∆∞u tr·ªØ v√† x·ª≠ l√Ω d·ªØ li·ªáu JSON b·∫±ng c√°ch cung c·∫•p c√°c t√≠nh nƒÉng v√† h√†m li√™n quan.

Trong SQL Server, JSON data l√† m·ªôt ki·ªÉu d·ªØ li·ªáu m·ªõi ƒë∆∞·ª£c gi·ªõi thi·ªáu t·ª´ phi√™n b·∫£n SQL Server 2016 tr·ªü ƒëi. N√≥ cho ph√©p b·∫°n l∆∞u tr·ªØ d·ªØ li·ªáu JSON trong c√°c c·ªôt JSON trong b·∫£ng SQL Server. C√°c c·ªôt JSON c√≥ th·ªÉ ch·ª©a c√°c ƒë·ªëi t∆∞·ª£ng JSON, m·∫£ng JSON ho·∫∑c gi√° tr·ªã JSON ƒë∆°n.

D∆∞·ªõi ƒë√¢y l√† m·ªôt s·ªë t√≠nh nƒÉng v√† h√†m quan tr·ªçng li√™n quan ƒë·∫øn JSON data trong SQL Server:

1. JSON Functions: SQL Server cung c·∫•p m·ªôt lo·∫°t c√°c h√†m ƒë·ªÉ x·ª≠ l√Ω v√† truy v·∫•n d·ªØ li·ªáu JSON. M·ªôt s·ªë h√†m quan tr·ªçng bao g·ªìm JSON_VALUE, JSON_QUERY, JSON_MODIFY v√† JSON_EXISTS. C√°c h√†m n√†y cho ph√©p b·∫°n tr√≠ch xu·∫•t, ch√®n, c·∫≠p nh·∫≠t v√† ki·ªÉm tra s·ª± t·ªìn t·∫°i c·ªßa c√°c gi√° tr·ªã JSON.

2. JSON Indexing: SQL Server cung c·∫•p kh·∫£ nƒÉng t·∫°o ch·ªâ m·ª•c tr√™n c√°c c·ªôt JSON, cho ph√©p t√¨m ki·∫øm v√† truy c·∫≠p d·ªØ li·ªáu JSON m·ªôt c√°ch hi·ªáu qu·∫£. Ch·ªâ m·ª•c JSON gi√∫p tƒÉng t·ªëc truy v·∫•n v√† c·∫£i thi·ªán hi·ªáu su·∫•t khi l√†m vi·ªác v·ªõi JSON data.

3. JSON Schema Validation: SQL Server h·ªó tr·ª£ x√°c th·ª±c JSON data b·∫±ng c√°ch s·ª≠ d·ª•ng JSON schema. B·∫±ng c√°ch ƒë·ªãnh nghƒ©a m·ªôt JSON schema, b·∫°n c√≥ th·ªÉ ki·ªÉm tra t√≠nh h·ª£p l·ªá c·ªßa d·ªØ li·ªáu JSON v√† ƒë·∫£m b·∫£o r·∫±ng n√≥ tu√¢n theo m·ªôt c·∫•u tr√∫c nh·∫•t ƒë·ªãnh.

4. FOR JSON Clause: SQL Server cung c·∫•p m·ªánh ƒë·ªÅ FOR JSON ƒë·ªÉ truy v·∫•n d·ªØ li·ªáu t·ª´ c∆° s·ªü d·ªØ li·ªáu v√† xu·∫•t k·∫øt qu·∫£ d∆∞·ªõi d·∫°ng JSON. M·ªánh ƒë·ªÅ n√†y cho ph√©p b·∫°n truy v·∫•n d·ªØ li·ªáu t·ª´ c√°c b·∫£ng SQL Server v√† ƒë·ªãnh d·∫°ng k·∫øt qu·∫£ tr·∫£ v·ªÅ d∆∞·ªõi d·∫°ng JSON.

C√°c h√†m JSON trong SQL Server:  

#### üîπ FOR JSON PATH

D√πng ƒë·ªÉ chuy·ªÉn k·∫øt qu·∫£ c·ªßa m·ªôt c√¢u l·ªánh SELECT th√†nh m·ªôt ƒë·ªëi t∆∞·ª£ng JSON. V√≠ d·ª•:

```sql
SELECT
    O.*,
    (SELECT * FROM customers AS C WHERE O.customer_id = C.customer_id FOR JSON PATH, WITHOUT_ARRAY_WRAPPER) AS customer,
    (SELECT * FROM staffs AS S WHERE O.staff_id = S.staff_id FOR JSON PATH, WITHOUT_ARRAY_WRAPPER) AS staffs
FROM orders AS O
```

#### üîπ H√†m JSON_VALUE

D√πng ƒë·ªÉ tr√≠ch xu·∫•t m·ªôt gi√° tr·ªã t·ª´ m·ªôt ƒë·ªëi t∆∞·ª£ng JSON. V√≠ d·ª•: Tr√≠ch xu·∫•t gi√° tr·ªã c·ªßa thu·ªôc t√≠nh name t·ª´ ƒë·ªëi t∆∞·ª£ng JSON {"name": "John", "age": 30}

```sql
SELECT JSON_VALUE('{"name": "John", "age": 30}', '$.name') AS name
```

#### üîπ H√†m JSON_QUERY

D√πng ƒë·ªÉ tr√≠ch xu·∫•t m·ªôt ƒë·ªëi t∆∞·ª£ng JSON t·ª´ m·ªôt ƒë·ªëi t∆∞·ª£ng JSON. V√≠ d·ª•: Tr√≠ch xu·∫•t ƒë·ªëi t∆∞·ª£ng JSON `{"name": "John", "age": 30} t·ª´ ƒë·ªëi t∆∞·ª£ng JSON {"name": "John", "age": 30, "address": {"street": "123 Main St.", "city": "New York"}}`

```sql
SELECT JSON_QUERY('{"name": "John", "age": 30, "address": {"street": "123 Main St.", "city": "New York"}}', '$.address') AS address
```

#### üîπ H√†m JSON_MODIFY

D√πng ƒë·ªÉ thay ƒë·ªïi m·ªôt gi√° tr·ªã trong m·ªôt ƒë·ªëi t∆∞·ª£ng JSON. V√≠ d·ª•: Thay ƒë·ªïi gi√° tr·ªã c·ªßa thu·ªôc t√≠nh name t·ª´ John th√†nh Jane trong ƒë·ªëi t∆∞·ª£ng JSON {"name": "John", "age": 30}

```sql
SELECT JSON_MODIFY('{"name": "John", "age": 30}', '$.name', 'Jane') AS name
```

#### üîπ H√†m ISJSON

D√πng ƒë·ªÉ ki·ªÉm tra m·ªôt chu·ªói c√≥ ph·∫£i l√† m·ªôt ƒë·ªëi t∆∞·ª£ng JSON hay kh√¥ng. V√≠ d·ª•: Ki·ªÉm tra chu·ªói {"name": "John", "age": 30} c√≥ ph·∫£i l√† m·ªôt ƒë·ªëi t∆∞·ª£ng JSON hay kh√¥ng

```sql
SELECT ISJSON('{"name": "John", "age": 30}') AS is_json
```

#### üîπ H√†m OPENJSON

D√πng ƒë·ªÉ chuy·ªÉn m·ªôt ƒë·ªëi t∆∞·ª£ng JSON th√†nh m·ªôt b·∫£ng. V√≠ d·ª•: Chuy·ªÉn ƒë·ªëi t∆∞·ª£ng JSON {"name": "John", "age": 30} th√†nh b·∫£ng

```sql
SELECT * FROM OPENJSON('{"name": "John", "age": 30}')
```

#### üîπ C√°c v·ªã d·ª• thao t√°c v·ªõi d·ªØ li·ªáu JSON

Trong SQL Server, b·∫°n c√≥ th·ªÉ th·ª±c hi·ªán c√°c thao t√°c th√™m m·ªõi, s·ª≠a, x√≥a v√† c·∫≠p nh·∫≠t d·ªØ li·ªáu JSON b·∫±ng c√°ch s·ª≠ d·ª•ng c√°c h√†m v√† to√°n t·ª≠ JSON t√≠ch h·ª£p. D∆∞·ªõi ƒë√¢y l√† c√°c v√≠ d·ª• v·ªÅ c√°ch th·ª±c hi·ªán c√°c thao t√°c n√†y.

1. Th√™m m·ªõi d·ªØ li·ªáu JSON:
   ƒê·ªÉ th√™m m·ªõi d·ªØ li·ªáu JSON v√†o m·ªôt c·ªôt ki·ªÉu d·ªØ li·ªáu JSON trong SQL Server, b·∫°n c√≥ th·ªÉ s·ª≠ d·ª•ng to√°n t·ª≠ `JSON_MODIFY()` ho·∫∑c h√†m `JSON_VALUE()`. V√≠ d·ª•:

   ````sql
   -- Th√™m m·ªõi m·ªôt ƒë·ªëi t∆∞·ª£ng JSON v√†o c·ªôt 'jsonData'
   UPDATE YourTable
   SET jsonData = JSON_MODIFY(jsonData, '$.name', 'John', '$.age', 25)

   -- Th√™m m·ªõi m·ªôt m·∫£ng JSON v√†o c·ªôt 'jsonData'
   UPDATE YourTable
   SET jsonData = JSON_MODIFY(jsonData, 'append $', JSON_QUERY('{"name": "John", "age": 25}'))
   ```

2. S·ª≠a d·ªØ li·ªáu JSON:
   ƒê·ªÉ s·ª≠a ƒë·ªïi c√°c gi√° tr·ªã trong d·ªØ li·ªáu JSON, b·∫°n c√≥ th·ªÉ s·ª≠ d·ª•ng to√°n t·ª≠ `JSON_MODIFY()`. V√≠ d·ª•:

   ````sql
   -- S·ª≠a ƒë·ªïi gi√° tr·ªã c·ªßa thu·ªôc t√≠nh 'name' trong c·ªôt 'jsonData'
   UPDATE YourTable
   SET jsonData = JSON_MODIFY(jsonData, '$.name', 'Jane')
   WHERE ID = 1
   ```

3. X√≥a d·ªØ li·ªáu JSON:
   ƒê·ªÉ x√≥a m·ªôt thu·ªôc t√≠nh ho·∫∑c m·ªôt ph·∫ßn t·ª≠ trong d·ªØ li·ªáu JSON, b·∫°n c√≥ th·ªÉ s·ª≠ d·ª•ng to√°n t·ª≠ `JSON_MODIFY()` ho·∫∑c h√†m `JSON_REMOVE()`. V√≠ d·ª•:

   ````sql
   -- X√≥a thu·ªôc t√≠nh 'name' trong c·ªôt 'jsonData'
   UPDATE YourTable
   SET jsonData = JSON_MODIFY(jsonData, '$.name', NULL)
   WHERE ID = 1

   -- X√≥a ph·∫ßn t·ª≠ th·ª© hai trong m·ªôt m·∫£ng JSON
   UPDATE YourTable
   SET jsonData = JSON_REMOVE(jsonData, '$[1]')
   WHERE ID = 1
   ```

4. C·∫≠p nh·∫≠t d·ªØ li·ªáu JSON:
   ƒê·ªÉ c·∫≠p nh·∫≠t d·ªØ li·ªáu JSON, b·∫°n c√≥ th·ªÉ k·∫øt h·ª£p c√°c ph√©p to√°n JSON nh∆∞ `JSON_MODIFY()`, `JSON_VALUE()`, v√† c√°c to√°n t·ª≠ SQL th√¥ng th∆∞·ªùng nh∆∞ `UPDATE`, `SET`, v√† `WHERE`. V√≠ d·ª•:

   ````sql
   -- C·∫≠p nh·∫≠t gi√° tr·ªã c·ªßa thu·ªôc t√≠nh 'age' trong c·ªôt 'jsonData'
   UPDATE YourTable
   SET jsonData = JSON_MODIFY(jsonData, '$.age', JSON_VALUE(jsonData, '$.age') + 1)
   WHERE ID = 1
   ```



---

## üíõ Session 17 - PolyBase, Query Store, and Stretch Database

### üí• PolyBase

PolyBase l√† m·ªôt t√≠nh nƒÉng trong SQL Server, ƒë∆∞·ª£c gi·ªõi thi·ªáu t·ª´ phi√™n b·∫£n SQL Server 2016 tr·ªü ƒëi. N√≥ cung c·∫•p kh·∫£ nƒÉng truy v·∫•n v√† t√≠ch h·ª£p d·ªØ li·ªáu t·ª´ c√°c ngu·ªìn d·ªØ li·ªáu b√™n ngo√†i SQL Server, bao g·ªìm d·ªØ li·ªáu trong c√°c h·ªá th·ªëng Hadoop, Azure Blob Storage, Oracle, Teradata v√† nhi·ªÅu ngu·ªìn d·ªØ li·ªáu kh√°c.

PolyBase cho ph√©p ng∆∞·ªùi d√πng truy v·∫•n d·ªØ li·ªáu t·ª´ c√°c ngu·ªìn kh√°c nhau th√¥ng qua ng√¥n ng·ªØ truy v·∫•n SQL ti√™u chu·∫©n v√† cung c·∫•p m·ªôt giao di·ªán ƒë∆°n gi·∫£n ƒë·ªÉ l√†m vi·ªác v·ªõi c√°c ngu·ªìn d·ªØ li·ªáu kh√¥ng li√™n quan. N√≥ t·∫≠n d·ª•ng s·ª± m·∫°nh m·∫Ω c·ªßa SQL Server ƒë·ªÉ x·ª≠ l√Ω v√† truy v·∫•n d·ªØ li·ªáu t·ª´ c√°c ngu·ªìn kh√°c nhau nh∆∞ m·ªôt ph·∫ßn c·ªßa m·ªôt truy v·∫•n SQL duy nh·∫•t.

PolyBase cho ph√©p t·∫°o c√°c b·∫£ng b√™n trong SQL Server c√≥ th·ªÉ truy v·∫•n tr·ª±c ti·∫øp d·ªØ li·ªáu t·ª´ c√°c ngu·ªìn b√™n ngo√†i. N√≥ cung c·∫•p c√°c tr√¨nh ƒëi·ªÅu khi·ªÉn (drivers) ƒë·ªÉ k·∫øt n·ªëi v√† truy v·∫•n d·ªØ li·ªáu t·ª´ c√°c ngu·ªìn kh√°c nhau, v√† c√°c truy v·∫•n PolyBase c√≥ th·ªÉ ƒë∆∞·ª£c vi·∫øt gi·ªëng nh∆∞ c√°c truy v·∫•n SQL th√¥ng th∆∞·ªùng.

V√≠ d·ª•, b·∫°n c√≥ th·ªÉ t·∫°o m·ªôt b·∫£ng trong SQL Server v√† s·ª≠ d·ª•ng PolyBase ƒë·ªÉ truy v·∫•n d·ªØ li·ªáu t·ª´ Hadoop. B·∫±ng c√°ch s·ª≠ d·ª•ng c√¢u l·ªánh SELECT th√¥ng th∆∞·ªùng, b·∫°n c√≥ th·ªÉ k·∫øt h·ª£p d·ªØ li·ªáu t·ª´ b·∫£ng trong SQL Server v√† d·ªØ li·ªáu t·ª´ Hadoop trong c√πng m·ªôt truy v·∫•n.

PolyBase c≈©ng cung c·∫•p kh·∫£ nƒÉng t·ªëi ∆∞u h√≥a truy v·∫•n v√† truy·ªÅn d·ªØ li·ªáu song song gi·ªØa SQL Server v√† c√°c ngu·ªìn d·ªØ li·ªáu b√™n ngo√†i, gi√∫p c·∫£i thi·ªán hi·ªáu su·∫•t v√† kh·∫£ nƒÉng m·ªü r·ªông c·ªßa h·ªá th·ªëng.

T√≥m l·∫°i, PolyBase l√† m·ªôt t√≠nh nƒÉng quan tr·ªçng trong SQL Server, cho ph√©p truy v·∫•n v√† t√≠ch h·ª£p d·ªØ li·ªáu t·ª´ c√°c ngu·ªìn d·ªØ li·ªáu kh√¥ng li√™n quan v√†o SQL Server b·∫±ng c√°ch s·ª≠ d·ª•ng ng√¥n ng·ªØ truy v·∫•n SQL ti√™u chu·∫©n. N√≥ m·ªü ra kh·∫£ nƒÉng k·∫øt h·ª£p v√† ph√¢n t√≠ch d·ªØ li·ªáu t·ª´ nhi·ªÅu ngu·ªìn kh√°c nhau trong m·ªôt m√¥i tr∆∞·ªùng SQL Server ƒë∆°n gi·∫£n v√† hi·ªáu qu·∫£.

---

### üí• Query Store

Query Store l√† m·ªôt t√≠nh nƒÉng trong SQL Server t·ª´ phi√™n b·∫£n SQL Server 2016 tr·ªü ƒëi, ƒë∆∞·ª£c thi·∫øt k·∫ø ƒë·ªÉ gi√∫p qu·∫£n l√Ω v√† t·ªëi ∆∞u h√≥a hi·ªáu su·∫•t c√°c truy v·∫•n trong c∆° s·ªü d·ªØ li·ªáu. N√≥ gi√°m s√°t, l∆∞u tr·ªØ v√† ph√¢n t√≠ch th√¥ng tin v·ªÅ c√°c truy v·∫•n ƒë∆∞·ª£c th·ª±c thi trong SQL Server, cho ph√©p ng∆∞·ªùi qu·∫£n tr·ªã v√† nh√† ph√°t tri·ªÉn d·ªÖ d√†ng xem v√† ph√¢n t√≠ch c√°c ho·∫°t ƒë·ªông truy v·∫•n.

C√°c kh√°i ni·ªám quan tr·ªçng trong Query Store bao g·ªìm:

1. Query Store Database: Query Store s·ª≠ d·ª•ng m·ªôt c∆° s·ªü d·ªØ li·ªáu ri√™ng g·ªçi l√† Query Store Database ƒë·ªÉ l∆∞u tr·ªØ th√¥ng tin v·ªÅ c√°c truy v·∫•n. C∆° s·ªü d·ªØ li·ªáu n√†y t·ªìn t·∫°i b√™n trong SQL Server v√† ƒë∆∞·ª£c qu·∫£n l√Ω t·ª± ƒë·ªông b·ªüi h·ªá th·ªëng.

2. Query Store Data: Query Store thu th·∫≠p v√† l∆∞u tr·ªØ c√°c d·ªØ li·ªáu li√™n quan ƒë·∫øn c√°c truy v·∫•n, bao g·ªìm th√¥ng tin v·ªÅ k·∫ø ho·∫°ch truy v·∫•n, th·ªëng k√™, th·ªùi gian th·ª±c thi, v√† t√†i nguy√™n s·ª≠ d·ª•ng. C√°c d·ªØ li·ªáu n√†y ƒë∆∞·ª£c l∆∞u tr·ªØ trong c√°c b·∫£ng v√† ch·∫ø ƒë·ªô xem (views) trong Query Store Database.

3. Query Store Configuration: Query Store cung c·∫•p c√°c t√πy ch·ªçn c·∫•u h√¨nh ƒë·ªÉ ƒëi·ªÅu ch·ªânh c√°ch n√≥ ho·∫°t ƒë·ªông. C√°c t√πy ch·ªçn n√†y bao g·ªìm c·∫•u h√¨nh kho·∫£ng th·ªùi gian l∆∞u tr·ªØ d·ªØ li·ªáu, m·ª©c ƒë·ªô chi ti·∫øt c·ªßa th√¥ng tin thu th·∫≠p, v√† c√°c c·∫•u h√¨nh kh√°c li√™n quan ƒë·∫øn qu·∫£n l√Ω truy v·∫•n.

4. Query Store Reports: Query Store cung c·∫•p c√°c b√°o c√°o v√† giao di·ªán ƒë·ªì h·ªça ƒë·ªÉ hi·ªÉn th·ªã v√† ph√¢n t√≠ch th√¥ng tin v·ªÅ c√°c truy v·∫•n. C√°c b√°o c√°o n√†y cho ph√©p ng∆∞·ªùi d√πng xem c√°c truy v·∫•n ƒë∆∞·ª£c th·ª±c thi, thay ƒë·ªïi k·∫ø ho·∫°ch truy v·∫•n, t√†i nguy√™n s·ª≠ d·ª•ng, v√† c√°c th·ªëng k√™ li√™n quan kh√°c.

5. Query Performance Insights: Query Store gi√∫p cung c·∫•p c√°i nh√¨n s√¢u s·∫Øc v·ªÅ hi·ªáu su·∫•t truy v·∫•n. N√≥ cho ph√©p ng∆∞·ªùi d√πng x√°c ƒë·ªãnh c√°c truy v·∫•n ch·∫≠m, truy v·∫•n ti√™u t·ªën nhi·ªÅu t√†i nguy√™n, truy v·∫•n ƒë√£ thay ƒë·ªïi k·∫ø ho·∫°ch th·ª±c thi, v√† c√°c v·∫•n ƒë·ªÅ kh√°c li√™n quan ƒë·∫øn hi·ªáu su·∫•t.

T√≥m l·∫°i, Query Store l√† m·ªôt t√≠nh nƒÉng quan tr·ªçng trong SQL Server, gi√∫p qu·∫£n l√Ω v√† t·ªëi ∆∞u h√≥a hi·ªáu su·∫•t c√°c truy v·∫•n. N√≥ thu th·∫≠p th√¥ng tin v·ªÅ c√°c truy v·∫•n v√† cung c·∫•p c∆° s·ªü d·ªØ li·ªáu, c·∫•u h√¨nh, b√°o c√°o v√† giao di·ªán ƒë·ªÉ ph√¢n t√≠ch v√† gi√°m s√°t hi·ªáu su·∫•t truy v·∫•n.

#### K√≠ch ho·∫°t b·∫±ng giao di·ªán ƒë·ªì h·ªça

Trong SQL Server Management Studio, b·∫°n c√≥ th·ªÉ k√≠ch ho·∫°t Query Store b·∫±ng click ph·∫£i l√™n `Database` c·ªßa b·∫°n, sau ƒë√≥ ch·ªçn `Properties` --> `Query Store`.

Sau ƒë√≥ t·∫°i d√≤ng `Operation Mode (Requested)` --> ch·ªçn `Read Write`

![query-store](img/query-store.png)


**Operation Mode**

Gi√° tr·ªã h·ª£p l·ªá bao g·ªìm OFF, READ_ONLY v√† READ_WRITE. OFF t·∫Øt Query Store. Trong ch·∫ø ƒë·ªô READ_WRITE, Query Store thu th·∫≠p v√† l∆∞u tr·ªØ th√¥ng tin v·ªÅ k·∫ø ho·∫°ch truy v·∫•n v√† th·ªëng k√™ th·ª±c thi th·ªùi gian ch·∫°y. Trong ch·∫ø ƒë·ªô READ_ONLY, th√¥ng tin c√≥ th·ªÉ ƒë∆∞·ª£c ƒë·ªçc t·ª´ Query Store, nh∆∞ng th√¥ng tin m·ªõi kh√¥ng ƒë∆∞·ª£c th√™m v√†o. N·∫øu kh√¥ng gian c·∫•p ph√°t t·ªëi ƒëa c·ªßa Query Store ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng h·∫øt, ch·∫ø ƒë·ªô ho·∫°t ƒë·ªông c·ªßa Query Store s·∫Ω chuy·ªÉn sang ch·∫ø ƒë·ªô READ_ONLY.

**Operation Mode (Actual)**

L·∫•y ch·∫ø ƒë·ªô ho·∫°t ƒë·ªông th·ª±c t·∫ø c·ªßa Query Store.

**Operation Mode (Requested)**

L·∫•y v√† ƒë·∫∑t ch·∫ø ƒë·ªô ho·∫°t ƒë·ªông mong mu·ªën c·ªßa Query Store.

**Data Flush Interval (Minutes)**

X√°c ƒë·ªãnh t·∫ßn su·∫•t m√† d·ªØ li·ªáu ƒë∆∞·ª£c ghi v√†o Query Store ƒë∆∞·ª£c l∆∞u tr·ªØ xu·ªëng ƒëƒ©a. ƒê·ªÉ t·ªëi ∆∞u h√≥a hi·ªáu su·∫•t, d·ªØ li·ªáu ƒë∆∞·ª£c thu th·∫≠p b·ªüi Query Store ƒë∆∞·ª£c ghi b·∫•t ƒë·ªìng b·ªô xu·ªëng ƒëƒ©a. T·∫ßn su·∫•t m√† vi·ªác truy·ªÅn n√†y b·∫•t ƒë·ªìng b·ªô x·∫£y ra ƒë∆∞·ª£c c·∫•u h√¨nh.

**Statistics Collection Interval (Minutes)**
L·∫•y v√† ƒë·∫∑t gi√° tr·ªã kho·∫£ng th·ªùi gian thu th·∫≠p th·ªëng k√™.

**Max Size (MB)**

L·∫•y v√† ƒë·∫∑t t·ªïng kh√¥ng gian ƒë∆∞·ª£c c·∫•p ph√°t cho Query Store.

**Query Store Capture Mode**

- None: kh√¥ng thu th·∫≠p c√°c truy v·∫•n m·ªõi.

- All: thu th·∫≠p t·∫•t c·∫£ c√°c truy v·∫•n.

- Auto: thu th·∫≠p c√°c truy v·∫•n d·ª±a tr√™n s·ª≠ d·ª•ng t√†i nguy√™n.
- Custom: ch·∫ø ƒë·ªô t√πy ch·ªânh h∆°n



**Stale Query Threshold (Days)**

L·∫•y v√† ƒë·∫∑t ng∆∞·ª°ng truy v·∫•n ƒë√£ l·ªói th·ªùi. C·∫•u h√¨nh ƒë·ªëi s·ªë STALE_QUERY_THRESHOLD_DAYS ƒë·ªÉ ch·ªâ ƒë·ªãnh s·ªë ng√†y gi·ªØ l·∫°i d·ªØ li·ªáu trong Query Store.

**Purge Query Data**

X√≥a n·ªôi dung c·ªßa Query Store.

Xem th√™m: 

- [https://learn.microsoft.com/en-us/sql/relational-databases/performance/manage-the-query-store?view=sql-server-ver16&tabs=tsql](https://learn.microsoft.com/en-us/sql/relational-databases/performance/manage-the-query-store?view=sql-server-ver16&tabs=tsql)

- [https://www.sqlshack.com/sql-server-query-store-overview/](https://www.sqlshack.com/sql-server-query-store-overview/)
---

#### K√≠ch ho·∫°t b·∫±ng T-SQL


```sql
ALTER DATABASE [QueryStoreDB]
SET QUERY_STORE = ON
    (
      OPERATION_MODE = READ_WRITE,
      CLEANUP_POLICY = ( STALE_QUERY_THRESHOLD_DAYS = 90 ),
      DATA_FLUSH_INTERVAL_SECONDS = 900,
      MAX_STORAGE_SIZE_MB = 1000,
      INTERVAL_LENGTH_MINUTES = 60,
      SIZE_BASED_CLEANUP_MODE = AUTO,
      QUERY_CAPTURE_MODE = CUSTOM,
      QUERY_CAPTURE_POLICY = (
        STALE_CAPTURE_POLICY_THRESHOLD = 24 HOURS,
        EXECUTION_COUNT = 30,
        TOTAL_COMPILE_CPU_TIME_MS = 1000,
        TOTAL_EXECUTION_CPU_TIME_MS = 100
      )
    );
```

Trong ƒë√≥:

| C·∫•u h√¨nh                 | M√¥ t·∫£                                                                                                          | Gi√° tr·ªã m·∫∑c ƒë·ªãnh                                    | Ghi ch√∫                           |
|-------------------------|----------------------------------------------------------------------------------------------------------------|----------------------------------------------------|----------------------------------|
| MAX_STORAGE_SIZE_MB     | X√°c ƒë·ªãnh gi·ªõi h·∫°n dung l∆∞·ª£ng d·ªØ li·ªáu m√† Query Store c√≥ th·ªÉ s·ª≠ d·ª•ng trong c∆° s·ªü d·ªØ li·ªáu kh√°ch h√†ng                | 100 tr∆∞·ªõc SQL Server 2019 (15.x)<br>1000 t·ª´ SQL Server 2019 (15.x) | √Åp d·ª•ng cho c∆° s·ªü d·ªØ li·ªáu m·ªõi |
| INTERVAL_LENGTH_MINUTES | X√°c ƒë·ªãnh th·ªùi gian m·ªói kho·∫£ng th·ªùi gian trong ƒë√≥ th·ªëng k√™ th·ªùi gian ch·∫°y c·ªßa c√°c k·∫ø ho·∫°ch truy v·∫•n ƒë∆∞·ª£c t·ªïng h·ª£p v√† l∆∞u tr·ªØ. M·ªói k·∫ø ho·∫°ch truy v·∫•n ho·∫°t ƒë·ªông c√≥ t·ªëi ƒëa m·ªôt h√†ng cho m·ªôt kho·∫£ng th·ªùi gian ƒë∆∞·ª£c x√°c ƒë·ªãnh b·∫±ng c·∫•u h√¨nh n√†y | 60                                                 | √Åp d·ª•ng cho c∆° s·ªü d·ªØ li·ªáu m·ªõi |
| STALE_QUERY_THRESHOLD_DAYS | Ch√≠nh s√°ch d·ª±a tr√™n th·ªùi gian ƒëi·ªÅu khi·ªÉn th·ªùi gian l∆∞u gi·ªØ c·ªßa th·ªëng k√™ th·ªùi gian ch·∫°y v√† c√°c truy v·∫•n kh√¥ng ho·∫°t ƒë·ªông | 30                                                 | √Åp d·ª•ng cho c∆° s·ªü d·ªØ li·ªáu m·ªõi v√† c∆° s·ªü d·ªØ li·ªáu c√≥ c√†i ƒë·∫∑t m·∫∑c ƒë·ªãnh tr∆∞·ªõc ƒë√≥ (367) |
| SIZE_BASED_CLEANUP_MODE | X√°c ƒë·ªãnh li·ªáu vi·ªác l√†m s·∫°ch d·ªØ li·ªáu t·ª± ƒë·ªông di·ªÖn ra khi k√≠ch th∆∞·ªõc d·ªØ li·ªáu Query Store ti·∫øn g·∫ßn ƒë·∫øn gi·ªõi h·∫°n | AUTO                                               | √Åp d·ª•ng cho t·∫•t c·∫£ c∆° s·ªü d·ªØ li·ªáu |
| QUERY_CAPTURE_MODE | X√°c ƒë·ªãnh li·ªáu t·∫•t c·∫£ c√°c truy v·∫•n hay ch·ªâ m·ªôt ph·∫ßn truy v·∫•n ƒë∆∞·ª£c theo d√µi | AUTO                                               | √Åp d·ª•ng cho t·∫•t c·∫£ c∆° s·ªü d·ªØ li·ªáu |
| DATA_FLUSH_INTERVAL_SECONDS | X√°c ƒë·ªãnh kho·∫£ng th·ªùi gian t·ªëi ƒëa m√† c√°c th·ªëng k√™ th·ªùi gian ch·∫°y ƒë√£ ƒë∆∞·ª£c ghi nh·ªõ trong b·ªô nh·ªõ tr∆∞·ªõc khi l∆∞u xu·ªëng ƒëƒ©a | 900                                                | √Åp d·ª•ng cho c∆° s·ªü d·ªØ li·ªáu m·ªõi |

L∆∞u √Ω r·∫±ng c√°c c·∫•u h√¨nh n√†y c√≥ th·ªÉ kh√°c nhau t√πy thu·ªôc v√†o phi√™n b·∫£n v√† c√†i ƒë·∫∑t c·ª• th·ªÉ c·ªßa SQL Server.

---

### üí• Stretch Database

Stretch Database l√† m·ªôt t√≠nh nƒÉng c√≥ s·∫µn trong SQL Server t·ª´ phi√™n b·∫£n SQL Server 2016 tr·ªü ƒëi, ƒë∆∞·ª£c thi·∫øt k·∫ø ƒë·ªÉ m·ªü r·ªông kh·∫£ nƒÉng l∆∞u tr·ªØ d·ªØ li·ªáu v√† c·∫£i thi·ªán hi·ªáu su·∫•t truy v·∫•n trong SQL Server b·∫±ng c√°ch t·ª± ƒë·ªông chuy·ªÉn d·ªØ li·ªáu gi·ªØa c∆° s·ªü d·ªØ li·ªáu local v√† Azure SQL Database.

Kh√°i ni·ªám ch√≠nh trong Stretch Database bao g·ªìm:

1. Local Database: ƒê√¢y l√† c∆° s·ªü d·ªØ li·ªáu SQL Server ch·ª©a d·ªØ li·ªáu c·ªßa b·∫°n tr√™n m√¥i tr∆∞·ªùng n·ªôi b·ªô. D·ªØ li·ªáu trong Local Database ƒë∆∞·ª£c t·ªï ch·ª©c v√† qu·∫£n l√Ω nh∆∞ b√¨nh th∆∞·ªùng.

2. Azure SQL Database: ƒê√¢y l√† m·ªôt d·ªãch v·ª• c∆° s·ªü d·ªØ li·ªáu qu·∫£n l√Ω c·ªßa Microsoft ch·∫°y tr√™n n·ªÅn t·∫£ng ƒëi·ªán to√°n ƒë√°m m√¢y Azure. Azure SQL Database l√† n∆°i d·ªØ li·ªáu b√™n ngo√†i ƒë∆∞·ª£c chuy·ªÉn ƒë·∫øn v√† l∆∞u tr·ªØ.

3. Stretch Database Table: Stretch Database cho ph√©p b·∫°n ch·ªçn c√°c b·∫£ng trong Local Database ƒë·ªÉ chuy·ªÉn d·ªØ li·ªáu l√™n Azure SQL Database. Nh·ªØng b·∫£ng n√†y g·ªçi l√† Stretch Database Tables. D·ªØ li·ªáu trong c√°c b·∫£ng n√†y ƒë∆∞·ª£c chia th√†nh hai ph·∫ßn: m·ªôt ph·∫ßn l∆∞u tr·ªØ trong Local Database v√† m·ªôt ph·∫ßn ƒë∆∞·ª£c chuy·ªÉn l√™n Azure SQL Database.

4. Data Migration: Khi b·∫°n ch·ªçn m·ªôt b·∫£ng l√† Stretch Database Table, d·ªØ li·ªáu trong b·∫£ng ƒë√≥ s·∫Ω ƒë∆∞·ª£c chuy·ªÉn l√™n Azure SQL Database theo m·ªôt quy tr√¨nh t·ª± ƒë·ªông. D·ªØ li·ªáu c≈© ƒë∆∞·ª£c l∆∞u tr·ªØ trong Local Database, trong khi d·ªØ li·ªáu m·ªõi v√† thay ƒë·ªïi ƒë∆∞·ª£c g·ª≠i ƒë·∫øn Azure SQL Database.

5. Transparent Data Access: M·ªôt khi d·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c chuy·ªÉn l√™n Azure SQL Database, b·∫°n v·∫´n c√≥ th·ªÉ truy c·∫≠p v√† truy v·∫•n d·ªØ li·ªáu ƒë√≥ th√¥ng qua Local Database. Stretch Database s·∫Ω t·ª± ƒë·ªông x·ª≠ l√Ω vi·ªác truy xu·∫•t d·ªØ li·ªáu t·ª´ c·∫£ hai n∆°i m√† kh√¥ng ƒë√≤i h·ªèi s·ª± can thi·ªáp t·ª´ ph√≠a ng∆∞·ªùi d√πng.

Stretch Database l√† m·ªôt c√¥ng c·ª• h·ªØu √≠ch ƒë·ªÉ qu·∫£n l√Ω d·ªØ li·ªáu l·ªõn trong SQL Server b·∫±ng c√°ch t·∫≠n d·ª•ng ƒëi·ªán to√°n ƒë√°m m√¢y. N√≥ gi√∫p m·ªü r·ªông kh·∫£ nƒÉng l∆∞u tr·ªØ v√† c·∫£i thi·ªán hi·ªáu su·∫•t truy v·∫•n b·∫±ng c√°ch t·ª± ƒë·ªông chuy·ªÉn d·ªØ li·ªáu gi·ªØa Local Database v√† Azure SQL Database.
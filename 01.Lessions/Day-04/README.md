# Day 04 - Session 06


## üíõ Modifying data

### üîπ INSERT

C√¢u l·ªánh INSERT cho ph√©p b·∫°n th√™m m·ªôt ho·∫∑c nhi·ªÅu b·∫£n ghi m·ªõi v√†o b·∫£ng d·ªØ li·ªáu.

C√∫ ph√°p:

```sql
INSERT INTO table_name (column1, column2, column3, ...)
VALUES (value1, value2, value3, ...);
```

N·∫øu b·∫°n mu·ªën ch√®n nhi·ªÅu b·∫£n ghi c√πng m·ªôt l√∫c, b·∫°n c√≥ th·ªÉ s·ª≠ d·ª•ng c√∫ ph√°p sau:

```sql
INSERT INTO table_name (column1, column2, column3, ...)
VALUES (value1, value2, value3, ...),
       (value1, value2, value3, ...),
       (value1, value2, value3, ...);
```

V√≠ d·ª•: T·∫°o table `promotion` cho demo

```sql
CREATE TABLE dbo.promotions (
    promotion_id INT PRIMARY KEY IDENTITY (1, 1),
    promotion_name VARCHAR (255) NOT NULL,
    discount DECIMAL (4, 2) DEFAULT 0,
    start_date DATE NOT NULL, --Ki·ªÉu ng√†y yyyy-mm-dd
    expired_date DATE NOT NULL --Ki·ªÉu ng√†y yyyy-mm-dd
); 
```

Th√™m 1 record v√†o `promotion`

```sql
INSERT INTO dbo.promotions (
    promotion_name,
    discount,
    start_date, --Ki·ªÉu ng√†y yyyy-mm-dd
    expired_date --Ki·ªÉu ng√†y yyyy-mm-dd
)
VALUES
    (
      '2018 Summer Promotion',
      0.15,
      '20180601',
      '20180901'
    );
-- L∆∞u √Ω: kh√¥ng c·∫ßn ƒë∆∞a promotion_id v√†o v√¨ n√≥ s·∫Ω t·ª± tƒÉng
```

Th√™m nhi·ªÅu record v√†o `promotion` trong m·ªôt c√¢u truy v·∫•n

```sql
INSERT INTO dbo.promotions (
    promotion_name,
    discount,
    start_date, --Ki·ªÉu ng√†y yyyy-mm-dd
    expired_date --Ki·ªÉu ng√†y yyyy-mm-dd
)
VALUES
    (
      '2018 Summer Promotion',
      0.15,
      '20180601',
      '20180901'
    ),
     (
      '2018 Chrismats Promotion',
      2,
      '20181201',
      '20181230'
    );
```

B·∫°n kh√¥ng th·ªÉ ch√®n gi√° tr·ªã v√†o c·ªôt ƒë∆∞·ª£c khai b√°o l√† `IDENTITY` b·ªüi v√¨ n√≥ s·∫Ω ƒë∆∞·ª£c t·∫°o t·ª± ƒë·ªông. Tuy nhi√™n b·∫°n v·∫´n mu·ªën l√†m th√¨ SQL Server c√≥ h·ªó tr·ª£:

```sql
--B∆∞·ªõc 1: ƒê·ªÉ c√¢u n√†y tr∆∞·ªõc c√¢u l·ªánh INSERT
SET IDENTITY_INSERT dbo.promotions ON; 
--B∆∞·ªõc 2: C√°c c√¢u l·ªánh INSERT
INSERT INTO dbo.promotions (
    promotion_id, --c√≥ ƒë∆∞a th√™m tr∆∞·ªùng IDENTITY
    promotion_name,
    discount,
    start_date, --Ki·ªÉu ng√†y yyyy-mm-dd
    expired_date --Ki·ªÉu ng√†y yyyy-mm-dd
)
VALUES
    (
      5, --ƒêi·ªÅn tr∆∞·ªõc m·ªôt gi√° tr·ªã ƒë√∫ng ki·ªÉu d·ªØ li·ªáu ƒë√£ khai b√°o
      '2018 Winter Promotion',
      0.2,
      '20180701',
      '20181001'
    );
--B∆∞·ªõc 3: T·∫Øt t√≠nh nƒÉng t·ª± ƒë·ªông sinh gi√° tr·ªã IDENTITY 
SET IDENTITY_INSERT dbo.promotions OFF; 
```

N·∫øu b·∫°n kh√¥ng thi·∫øt l·∫≠p `IDENTITY_INSERT` b·∫°n s·∫Ω g·∫∑p l·ªói:

```bash
Cannot insert explicit value for identity column in table 'promotions' when IDENTITY_INSERT is set to OFF.
```


**INSERT V·ªõi gi√° tr·ªã Unicode**

ƒê·ªÉ h·ªó tr·ª£ l∆∞u tr·ªØ v√† hi·ªÉn th·ªã c√°c gi√° tr·ªã l√† chu·ªói Unicode b·∫°n c·∫ßn:8

```sql
INSERT INTO table_name (column1, column2) VALUES (N'Xin Ch√†o', N'SQL Server kh√° d·ªÖ h·ªçc');
```

Trong ƒë√≥, ti·ªÅn t·ªë "N" tr∆∞·ªõc chu·ªói k√Ω t·ª± ƒë·∫£m b·∫£o r·∫±ng chu·ªói ƒë∆∞·ª£c coi l√† m·ªôt chu·ªói Unicode.


**INSERT INTO SELECT statement**

ƒê·ªÉ ch√®n d·ªØ li·ªáu t·ª´ table ƒë·∫øn table kh√°c b·∫°n c√≥ th·ªÉ s·ª≠ d·ª•ng m·ªánh ƒë·ªÅ `INSERT INTO SELECT`

C√∫ ph√°p:

```sql
INSERT  [ TOP ( expression ) [ PERCENT ] ] 
INTO target_table (column_list)
query;
```

V√≠ d·ª•:

```sql
-- T·∫°o c·∫•u tr√∫c b·∫£ng regions
CREATE TABLE dbo.regions (
    address_id INT IDENTITY PRIMARY KEY,
    street VARCHAR (255) NOT NULL,
    city VARCHAR (50),
    state VARCHAR (25),
    zip_code VARCHAR (5)
); 
-- L·∫•y d·ªØ li·ªáu t·ª´ table customer ƒë·ªï qua cho regions
INSERT INTO dbo.regions (street, city, state, zip_code) 
SELECT
    street,
    city,
    state,
    zip_code
FROM
    dbo.customers
ORDER BY
    first_name,
    last_name; 
```

**INSERT V·ªõi ki·ªÉu d·ªØ li·ªáu th·ªùi gian**


V√≠ d·ª• c√≥ b·∫£ng

```sql
CREATE TABLE dbo.visits (
    visit_id INT PRIMARY KEY IDENTITY,
    customer_name VARCHAR (50) NOT NULL,
    phone VARCHAR (25),
    store_id INT NOT NULL,
    visit_on DATE NOT NULL,
    start_at TIME (0) NOT NULL,
    end_at TIME (0) NOT NULL,
    create_at DATETIME2 NOT NULL, --ki·ªÉu yyyy-mm-dd H:i:s, kh√¥ng t·ª± ƒë·ªông t·∫°o
    modified_at DATETIME2 NOT NULL DEFAULT CURRENT_TIMESTAMP --ki·ªÉu yyyy-mm-dd H:i:s, t·ª± ƒë·ªông t·∫°o
    FOREIGN KEY (store_id) REFERENCES sales.stores (store_id)
);

--Ch√®n d·ªØ li·ªáu
INSERT INTO sales.visits (
    customer_name,
    phone,
    store_id,
    visit_on,
    start_at,
    end_at,
    create_at
)
VALUES
    (
        'John Doe',
        '(408)-993-3853',
        1,
        '2018-06-23',
        '09:10:00',
        '09:30:00',
        '2018-06-23 09:30:00'
    );
-- Tr∆∞·ªùng visit_id, modified_at kh√¥ng c·∫ßn ƒë∆∞a v√†o v√¨ n√≥ s·∫Ω t·∫°o t·ª± ƒë·ªông

```



### üîπ UPDATE

M·ªánh ƒë·ªÅ UPDATE d√πng ƒë·ªÉ thay ƒë·ªïi d·ªØ li·ªáu trong table

C√∫ ph√°p

```sql
UPDATE [schame_name].[table_name]
SET c1 = v1, c2 = v2, ... cn = vn
[WHERE condition]
```

L∆∞u √Ω: C√¢u l·ªánh UPDATE n√™n ƒëi k√®m v·ªõi m·ªánh ƒë·ªÅ WHERE ƒë·ªÉ gi·ªõi h·∫°n ph·∫°m vi t√°c ƒë·ªông c·ªßa d·ªØ li·ªáu, ƒë·ªÉ gi·∫£m b·ªõt sai s√≥t n·∫øu nh·∫ßm l·∫´n logic x·ª≠ l√Ω.

**UPDATE JOIN syntax**

```sql
UPDATE 
    t1
SET 
    t1.c1 = t2.c2,
    t1.c2 = expression,
    ...   
FROM 
    t1
    [INNER | LEFT] JOIN t2 ON join_predicate
WHERE 
    where_predicate;
```

T·∫°o d·ªØ li·ªáu demo

```sql
DROP TABLE IF EXISTS dbo.targets;

CREATE TABLE dbo.targets
(
    target_id  INT	PRIMARY KEY, 
    percentage DECIMAL(4, 2) 
        NOT NULL DEFAULT 0
);

INSERT INTO 
    dbo.targets(target_id, percentage)
VALUES
    (1,0.2),
    (2,0.3),
    (3,0.5),
    (4,0.6),
    (5,0.8);

CREATE TABLE dbo.commissions
(
    staff_id    INT PRIMARY KEY, 
    target_id   INT, 
    base_amount DECIMAL(10, 2) 
        NOT NULL DEFAULT 0, 
    commission  DECIMAL(10, 2) 
        NOT NULL DEFAULT 0, 
    FOREIGN KEY(target_id) 
        REFERENCES sales.targets(target_id), 
    FOREIGN KEY(staff_id) 
        REFERENCES sales.staffs(staff_id),
);

INSERT INTO 
    dbo.commissions(staff_id, base_amount, target_id)
VALUES
    (1,100000,2),
    (2,120000,1),
    (3,80000,3),
    (4,900000,4),
    (5,950000,5);
```

Y√™u c·∫ßu C·∫≠p nh·∫≠t ti·ªÅn th∆∞·ªüng (tr∆∞·ªùng commissions) ·ªü table `commissions` theo c√¥ng th·ª©c: `commissions = base_amount * percentage` m·∫∑c ƒë·ªãnh nh√¢n vi√™n m·ªõi s·∫Ω c√≥ m·ª©c chi·∫øt kh·∫•u percentage = 0.1


```sql
UPDATE 
    dbo.commissions
SET  
    dbo.commissions.commission = 
        c.base_amount  * COALESCE(t.percentage,0.1) -- COALESCE tr·∫£ v·ªÅ 0.1 n·∫øu percentage l√† NULL
FROM  
    dbo.commissions AS c
    LEFT JOIN dbo.targets t -- tham chi·∫øu ƒë·∫øn targets ƒë·ªÉ l·∫•y tr∆∞·ªùng percentage
        ON c.target_id = t.target_id;
```

### üîπ DELETE

C√¢u l·ªánh DELETE cho ph√©p b·∫°n lo·∫°i b·ªè d·ªØ li·ªáu kh√¥ng c·∫ßn thi·∫øt, kh√¥ng ch√≠nh x√°c ho·∫∑c kh√¥ng mu·ªën t·ª´ m·ªôt b·∫£ng c·ª• th·ªÉ trong c∆° s·ªü d·ªØ li·ªáu.

C√∫ ph√°p:

```sql
DELETE [ TOP ( expression ) [ PERCENT ] ]  
FROM table_name
[WHERE search_condition];
```

V√≠ d·ª• c√°c tr∆∞·ªùng h·ª£p:

```sql
-- X√≥a t·∫•t c·∫£ records t·ª´ table target_table
DELETE FROM target_table;
-- X√≥a 1 d√≤ng ƒë·∫ßu ti√™n
DELETE TOP 10 FROM target_table;  
-- X√≥a 10 % records ng·∫´u nhi√™n trong table
DELETE TOP 10 PERCENT FROM target_table;
```

**DELETE v·ªõi m·ªánh ƒë·ªÅ WHERE**

Th√¥ng th∆∞·ªùng c√¢u l·ªánh DELETE ƒëi k√®m ƒëi·ªÅu ki·ªán WHERE ƒë·ªÉ x√°c ƒë·ªãnh c·ª• th·ªÉ b·∫£n ghi n√†o c·∫ßn x√≥a

```sql
DELETE FROM dbo.commissions WHERE staff_id = 1
```



## üíõ SQL CONSTRAINT

CONSTRAINT (r√†ng bu·ªôc) l√† m·ªôt kh·ªëi m√£ ho·∫∑c m·ªôt quy t·∫Øc ƒë∆∞·ª£c √°p d·ª•ng cho m·ªôt ho·∫∑c nhi·ªÅu c·ªôt trong m·ªôt b·∫£ng ƒë·ªÉ ƒë·ªãnh nghƒ©a v√† b·∫£o v·ªá t√≠nh to√†n v·∫πn d·ªØ li·ªáu. R√†ng bu·ªôc ƒë·ªãnh nghƒ©a c√°c quy t·∫Øc v√† gi·ªõi h·∫°n cho d·ªØ li·ªáu ƒë∆∞·ª£c l∆∞u tr·ªØ trong c∆° s·ªü d·ªØ li·ªáu.

C√°c CONSTRAINT ph·ªï bi·∫øn:

### üîπ PRIMARY KEY

Primary key (Kh√≥a ch√≠nh) l√† m·ªôt thu·ªôc t√≠nh ho·∫∑c t·∫≠p h·ª£p c√°c thu·ªôc t√≠nh trong m·ªôt b·∫£ng d√πng ƒë·ªÉ ƒë·ªãnh danh duy nh·∫•t m·ªói h√†ng trong b·∫£ng ƒë√≥. Kh√≥a ch√≠nh ƒë·∫£m b·∫£o t√≠nh duy nh·∫•t v√† x√°c ƒë·ªãnh c·ªßa c√°c b·∫£n ghi trong b·∫£ng

L√† s·ª± k·∫øt h·ª£p gi·ªØa 2 CONSTRAINT `UNIQUE` v√† `NOT NULL`

```sql
-- ƒê·ªãnh nghƒ©a PRIMARY KEY ngay khi t·∫°o table
CREATE TABLE [dbo].[products] (
    product_id INT IDENTITY(1,1) PRIMARY KEY NOT NULL
)
-- ƒê·ªãnh nghƒ©a PRIMARY KEY cho table ƒë√£ t·ªìn t·∫°i
ALTER TABLE [dbo].[products]
ADD PRIMARY KEY (product_id);
-- Ho·∫∑c, b·∫°n c√≥ th·ªÉ ƒë·∫∑t t√™n cho contraint l√† PK_products_product_id
--Khuy√™n d√πng c√°ch n√†y ƒë·ªÉ x·∫£y ra l·ªói th√¨ d·ªÖ d√†ng nh·∫≠n bi·∫øt v√¨ c√≥ t√™n
ALTER TABLE [dbo].[products]
ADD CONSTRAINT [PK_products_product_id] PRIMARY KEY ([product_id]);
```

==> S·ª≠ d·ª•ng ti·∫øp ƒë·∫ßu ng·ªØ `pk_` ƒë·ªÉ nh·∫≠n bi·∫øt ƒë√≥ l√† kh√≥a ch√≠nh

Ngo√†i c√°ch d√πng `IDENTITY` b·∫°n c√≥ th·ªÉ s·ª≠ m·ªôt ph∆∞∆°ng th·ª©c m·ªõi h∆°n l√† `GUID`

```sql
SELECT NEWID() AS GUID;
-- Cho ra ƒë∆∞·ª£c: 3297F0F2-35D3-4231-919D-1CFCF4035975
-- ƒê·∫£m b·∫£o ƒë∆∞·ª£c t√≠nh duy nh·∫•t khi l√†m kh√≥a ch√≠nh
```

B·∫°n c√≥ th·ªÉ √°p d·ª•ng GUID l√†m `primary key`

```sql
CREATE TABLE dbo.customers(
    customer_id UNIQUEIDENTIFIER DEFAULT NEWID(),
    first_name NVARCHAR(100) NOT NULL,
    last_name NVARCHAR(100) NOT NULL,
    email VARCHAR(200) NOT NULL
);
-- Trong ƒë√≥: UNIQUEIDENTIFIER ==> ƒê·∫£m b·∫£o ƒë·ªãnh danh duy nh·∫•t, kh√¥ng tr√πng l·∫∑p, 
-- DEFAULT NEWID() --> t·ª± ƒë·ªông t·∫°o
```
**X√≥a Kh√≥a ch√≠nh**

```sql
ALTER TABLE table_name
DROP CONSTRAINT constraint_name;
```

V√≠ d·ª•

```sql
ALTER TABLE dbo.products
DROP CONSTRAINT PK_products_product_id;
```


N·∫øu nh∆∞ kh√≥a ch√≠nh ch∆∞a set t·ª± ƒë·ªông tƒÉng tr∆∞·ªõc ƒë√≥ b·∫°n c√≥ th·ªÉ t·∫°o nh∆∞ sau

```sql
-- x√≥a kh√≥a ch√≠nh
ALTER TABLE dbo.products
DROP CONSTRAINT PK_products_product_id;
--x√≥a c·ªôt product_id
ALTER TABLE dbo.products DROP COLUMN product_id
--t·∫°o l·∫°i product_id v·ªõi IDENTITY
ALTER TABLE dbo.products
ADD product_id INT IDENTITY(1,1)
--Thi·∫øt l·∫≠p l·∫°i kh√≥a ch√≠nh
ALTER TABLE [dbo].[products]
ADD CONSTRAINT [PK_products_product_id] PRIMARY KEY ([product_id]);
--
Go
```




### üîπ FOREIGN KEY 

- Foreign key (kh√≥a ngo·∫°i) l√† m·ªôt c·ªôt ho·∫∑c t·∫≠p h·ª£p c√°c c·ªôt trong m·ªôt b·∫£ng tham chi·∫øu ƒë·∫øn kh√≥a ch√≠nh c·ªßa m·ªôt b·∫£ng kh√°c. Kh√≥a ngo·∫°i t·∫°o ra m·ªôt m·ªëi quan h·ªá gi·ªØa hai b·∫£ng d·ª±a tr√™n gi√° tr·ªã c·ªßa c·ªôt ho·∫∑c c√°c c·ªôt ƒë∆∞·ª£c li√™n k·∫øt.

- B·∫£ng ch·ª©a kh√≥a ngo·∫°i ƒë∆∞·ª£c g·ªçi l√† b·∫£ng tham chi·∫øu ho·∫∑c b·∫£ng con. V√† b·∫£ng ƒë∆∞·ª£c tham chi·∫øu b·ªüi kh√≥a ngo·∫°i ƒë∆∞·ª£c g·ªçi l√† b·∫£ng ƒë∆∞·ª£c tham chi·∫øu ho·∫∑c b·∫£ng cha.

- M·ªôt b·∫£ng c√≥ th·ªÉ c√≥ nhi·ªÅu kh√≥a ngo·∫°i t√πy thu·ªôc v√†o m·ªëi quan h·ªá c·ªßa n√≥ v·ªõi c√°c b·∫£ng kh√°c.

- B·∫°n x√°c ƒë·ªãnh kh√≥a ngo·∫°i b·∫±ng c√°ch s·ª≠ d·ª•ng r√†ng bu·ªôc kh√≥a ngo·∫°i. R√†ng bu·ªôc kh√≥a ngo·∫°i gi√∫p duy tr√¨ t√≠nh to√†n v·∫πn tham chi·∫øu c·ªßa d·ªØ li·ªáu gi·ªØa b·∫£ng con v√† b·∫£ng cha.

- R√†ng bu·ªôc kh√≥a ngo·∫°i ch·ªâ ra r·∫±ng c√°c gi√° tr·ªã trong m·ªôt c·ªôt ho·∫∑c m·ªôt nh√≥m c·ªôt trong b·∫£ng con b·∫±ng v·ªõi c√°c gi√° tr·ªã trong m·ªôt c·ªôt ho·∫∑c m·ªôt nh√≥m c·ªôt c·ªßa b·∫£ng cha.

```sql
-- T·∫°o kh√≥a ngo·∫°i category_id, brand_id ngay khi t·∫°o m·ªõi Table
CREATE TABLE [dbo].[products] (
  [product_id] INT IDENTITY(1,1) PRIMARY KEY NOT NULL, --T·ª± tƒÉng
  [product_name] NVARCHAR(100) NOT NULL,
  [price] DECIMAL(18,2) NOT NULL,
  [discount] DECIMAL(4,2) NOT NULL,
  [description] NVARCHAR(MAX) NULL,
  [category_id] INT NOT NULL,
  [brand_id] INT NOT NULL,
  CONSTRAINT FK_products_category_id FOREIGN KEY (category_id) 
        REFERENCES categories(category_id), --Kh√≥a ngo·∫°i category_id
  CONSTRAINT FK_products_brand_id FOREIGN KEY (brand_id) 
        REFERENCES brands(brand_id) --Kh√≥a ngo·∫°i brand_id
);
```

==> S·ª≠ d·ª•ng ti·∫øp ƒë·∫ßu ng·ªØ `fk_` ƒë·ªÉ nh·∫≠n bi·∫øt ƒë√≥ l√† kh√≥a ngo·∫°i


Ho·∫∑c b·∫°n c√≥ th·ªÉ t·∫°o kh√≥a ngo·∫°i cho m·ªôt table ƒë√£ t·ªìn t·∫°i

```sql
--T·∫°o kh√≥a ngo·∫°i  FOREIGN KEY (category_id) tham chi·∫øu ƒë·∫øn kh√≥a ch√≠nh categories(Id)
ALTER TABLE [dbo].[products]
ADD CONSTRAINT [FK_products_categories] FOREIGN KEY ([category_id]) REFERENCES [dbo].[categories] ([category_id]);
GO
--T·∫°o kh√≥a ngo·∫°i FOREIGN KEY (brand_id) tham chi·∫øu ƒë·∫øn kh√≥a ch√≠nh brands(brand_id)
ALTER TABLE [dbo].[products]
ADD CONSTRAINT [FK_products_brands_id] FOREIGN KEY ([brand_id]) REFERENCES [dbo].[brands] ([brand_id]);
```

**X√≥a Kh√≥a ph·ª•**

```sql
ALTER TABLE table_name
DROP CONSTRAINT constraint_name;
```

V√≠ d·ª•

```sql
ALTER TABLE dbo.products
DROP CONSTRAINT FK_products_brands_id
```

**üì¢ Kh√≥a ngo·∫°i v·ªõi t√πy ch·ªçn tham chi·∫øu**

C√¢u l·ªánh FOREIGN KEY trong SQL Server ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ t·∫°o r√†ng bu·ªôc kh√≥a ngo·∫°i gi·ªØa hai b·∫£ng trong c∆° s·ªü d·ªØ li·ªáu. R√†ng bu·ªôc kh√≥a ngo·∫°i ƒë·∫£m b·∫£o t√≠nh to√†n v·∫πn d·ªØ li·ªáu b·∫±ng c√°ch x√°c ƒë·ªãnh m·ªëi quan h·ªá gi·ªØa c√°c b·∫£ng th√¥ng qua kh√≥a ngo·∫°i v√† kh√≥a ch√≠nh.

C√∫ ph√°p chung c·ªßa c√¢u l·ªánh FOREIGN KEY nh∆∞ sau:

```sql
FOREIGN KEY (foreign_key_columns)
    REFERENCES parent_table(parent_key_columns)
    ON UPDATE CASCADE |  SET NULL | SET DEFAULT | NO ACTION | RESTRICT
    ON DELETE CASCADE |  SET NULL | SET DEFAULT | NO ACTION | RESTRICT;
```

- `foreign_key_columns`: L√† danh s√°ch c√°c c·ªôt trong b·∫£ng hi·ªán t·∫°i, ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a l√† kh√≥a ngo·∫°i v√† s·∫Ω tham chi·∫øu ƒë·∫øn kh√≥a ch√≠nh trong b·∫£ng cha.
- `parent_table`: L√† t√™n c·ªßa b·∫£ng cha, t·ª©c l√† b·∫£ng m√† c√°c c·ªôt kh√≥a ch√≠nh ƒë∆∞·ª£c tham chi·∫øu ƒë·∫øn.
- `parent_key_columns`: L√† danh s√°ch c√°c c·ªôt kh√≥a ch√≠nh trong b·∫£ng cha.
- `ON UPDATE action`: X√°c ƒë·ªãnh h√†nh ƒë·ªông khi gi√° tr·ªã c·ªßa kh√≥a ch√≠nh trong b·∫£ng cha ƒë∆∞·ª£c c·∫≠p nh·∫≠t. C√≥ th·ªÉ l√† `CASCADE`, `SET NULL`, `SET DEFAULT`, `NO ACTION` ho·∫∑c `RESTRICT`.
- `ON DELETE action`: X√°c ƒë·ªãnh h√†nh ƒë·ªông khi m·ªôt h√†ng trong b·∫£ng cha b·ªã x√≥a. C√≥ th·ªÉ l√† `CASCADE`, `SET NULL`, `SET DEFAULT`, `NO ACTION` ho·∫∑c `RESTRICT`.

Trong ƒë√≥:

1. SET DEFAULT: Khi s·ª≠ d·ª•ng "SET DEFAULT", n·∫øu m·ªôt b·∫£n ghi trong b·∫£ng cha (parent table) ƒë∆∞·ª£c c·∫≠p nh·∫≠t ho·∫∑c x√≥a, v√† c√≥ c√°c b·∫£n ghi t∆∞∆°ng ·ª©ng trong b·∫£ng con (child table) s·ª≠ d·ª•ng kh√≥a ngo·∫°i, gi√° tr·ªã c·ªßa c√°c c·ªôt kh√≥a ngo·∫°i trong b·∫£ng con s·∫Ω ƒë∆∞·ª£c ƒë·∫∑t v·ªÅ gi√° tr·ªã m·∫∑c ƒë·ªãnh (default value) ƒë√£ ƒë∆∞·ª£c x√°c ƒë·ªãnh tr∆∞·ªõc ƒë√≥. N·∫øu kh√¥ng c√≥ gi√° tr·ªã m·∫∑c ƒë·ªãnh, th√¨ m·ªôt l·ªói c√≥ th·ªÉ x·∫£y ra.

2. NO ACTION: Khi s·ª≠ d·ª•ng "NO ACTION", n·∫øu c√≥ s·ª± thay ƒë·ªïi trong b·∫£ng cha, nh∆∞ng c√°c b·∫£n ghi trong b·∫£ng con v·∫´n c√≥ tham chi·∫øu ƒë·∫øn c√°c b·∫£n ghi trong b·∫£ng cha, th√¨ NO ACTION s·∫Ω ngƒÉn ch·∫∑n c√°c thay ƒë·ªïi n√†y. Nghƒ©a l√†, h·ªá th·ªëng s·∫Ω kh√¥ng th·ª±c hi·ªán thay ƒë·ªïi ho·∫∑c x√≥a b·∫£n ghi trong b·∫£ng cha n·∫øu c√≥ c√°c b·∫£n ghi con li√™n quan. ƒêi·ªÅu n√†y ƒë·∫£m b·∫£o t√≠nh nh·∫•t qu√°n c·ªßa d·ªØ li·ªáu, nh∆∞ng c√≥ th·ªÉ g√¢y ra l·ªói n·∫øu kh√¥ng ƒë∆∞·ª£c x·ª≠ l√Ω c·∫©n th·∫≠n.

3. RESTRICT: RESTRICT t∆∞∆°ng t·ª± nh∆∞ NO ACTION, nghƒ©a l√† n√≥ ngƒÉn ch·∫∑n s·ª± thay ƒë·ªïi ho·∫∑c x√≥a b·∫£n ghi trong b·∫£ng cha khi c√≥ c√°c b·∫£n ghi con li√™n quan. RESTRICT c≈©ng ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ ƒë·∫£m b·∫£o r√†ng bu·ªôc d·ªØ li·ªáu v√† t√≠nh nh·∫•t qu√°n, v√† c√≥ th·ªÉ g√¢y ra l·ªói n·∫øu kh√¥ng ƒë∆∞·ª£c x·ª≠ l√Ω c·∫©n th·∫≠n.

4. CASCADE: Khi s·ª≠ d·ª•ng "CASCADE" trong m·ªánh ƒë·ªÅ FOREIGN KEY, n·∫øu c√≥ s·ª± thay ƒë·ªïi trong b·∫£ng cha, nh∆∞ c·∫≠p nh·∫≠t ho·∫∑c x√≥a b·∫£n ghi, c√°c thay ƒë·ªïi t∆∞∆°ng ·ª©ng s·∫Ω ƒë∆∞·ª£c t·ª± ƒë·ªông lan truy·ªÅn (cascade) ƒë·∫øn b·∫£ng con. Nghƒ©a l√†, c√°c b·∫£n ghi trong b·∫£ng con c√≥ kh√≥a ngo·∫°i tr√πng kh·ªõp s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t ho·∫∑c x√≥a m·ªôt c√°ch t·ª± ƒë·ªông.

5. SET NULL: Khi s·ª≠ d·ª•ng "SET NULL", n·∫øu m·ªôt b·∫£n ghi trong b·∫£ng cha ƒë∆∞·ª£c c·∫≠p nh·∫≠t ho·∫∑c x√≥a, v√† c√≥ c√°c b·∫£n ghi t∆∞∆°ng ·ª©ng trong b·∫£ng con s·ª≠ d·ª•ng kh√≥a ngo·∫°i, gi√° tr·ªã c·ªßa c√°c c·ªôt kh√≥a ngo·∫°i trong b·∫£ng con s·∫Ω ƒë∆∞·ª£c ƒë·∫∑t v·ªÅ NULL. ƒêi·ªÅu n√†y cho ph√©p t·ªìn t·∫°i c√°c b·∫£n ghi trong b·∫£ng con kh√¥ng c√≥ li√™n k·∫øt v·ªõi b·∫£ng cha.

T√≥m l·∫°i, khi s·ª≠ d·ª•ng c√°c t·ª´ kh√≥a trong m·ªánh ƒë·ªÅ FOREIGN KEY, ch√∫ng ta c√≥ th·ªÉ x√°c ƒë·ªãnh c√°ch th·ª©c x·ª≠ l√Ω d·ªØ li·ªáu li√™n quan ƒë·∫øn kh√≥a ngo·∫°i khi c√≥ s·ª± thay ƒë·ªïi trong b·∫£ng cha. M·ªói t·ª´ kh√≥a c√≥ √Ω nghƒ©a v√† t√°c ƒë·ªông kh√°c nhau l√™n d·ªØ li·ªáu v√† c√°c b·∫£ng li√™n quan. L·ª±a ch·ªçn t·ª´ kh√≥a ph√π h·ª£p ph·ª• thu·ªôc v√†o y√™u c·∫ßu kinh doanh v√† m√¥ h√¨nh d·ªØ li·ªáu c·ªßa h·ªá th·ªëng.


V√≠ d·ª•, ƒë·ªÉ t·∫°o m·ªôt r√†ng bu·ªôc kh√≥a ngo·∫°i trong b·∫£ng "Orders" tham chi·∫øu ƒë·∫øn kh√≥a ch√≠nh "OrderID" trong b·∫£ng "Customers", v√† khi kh√≥a ch√≠nh trong b·∫£ng "Customers" ƒë∆∞·ª£c c·∫≠p nh·∫≠t ho·∫∑c x√≥a, c√°c h√†nh ƒë·ªông t∆∞∆°ng ·ª©ng ƒë∆∞·ª£c th·ª±c hi·ªán, b·∫°n c√≥ th·ªÉ s·ª≠ d·ª•ng c√¢u l·ªánh sau:

```sql
ALTER TABLE Orders
ADD FOREIGN KEY (CustomerID)
REFERENCES Customers(CustomerID)
ON UPDATE CASCADE
ON DELETE SET NULL;
```

Trong v√≠ d·ª• tr√™n, c·ªôt "CustomerID" trong b·∫£ng "Orders" ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a l√† kh√≥a ngo·∫°i, tham chi·∫øu ƒë·∫øn c·ªôt "CustomerID" trong b·∫£ng "Customers".

- Khi kh√≥a ch√≠nh trong b·∫£ng "Customers" ƒë∆∞·ª£c c·∫≠p nh·∫≠t, c√°c b·∫£n ghi t∆∞∆°ng ·ª©ng trong b·∫£ng "Orders" s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t theo (`ON UPDATE CASCADE`). 
- Khi m·ªôt b·∫£n ghi trong b·∫£ng "Customers" b·ªã x√≥a, gi√° tr·ªã kh√≥a ngo·∫°i trong b·∫£ng "Orders" s·∫Ω ƒë∆∞·ª£c ƒë·∫∑t th√†nh NULL (`ON DELETE SET NULL`).




### üîπ UNIQUE

SQL cung c·∫•p cho b·∫°n r√†ng bu·ªôc UNIQUE ƒë·ªÉ duy tr√¨ t√≠nh duy nh·∫•t c·ªßa d·ªØ li·ªáu m·ªôt c√°ch ch√≠nh x√°c.

Khi c√≥ r√†ng bu·ªôc UNIQUE, m·ªói khi b·∫°n ch√®n m·ªôt h√†ng m·ªõi, n√≥ s·∫Ω ki·ªÉm tra xem gi√° tr·ªã ƒë√£ c√≥ trong b·∫£ng ch∆∞a. N√≥ t·ª´ ch·ªëi thay ƒë·ªïi v√† ƒë∆∞a ra l·ªói n·∫øu gi√° tr·ªã ƒë√£ t·ªìn t·∫°i. Qu√° tr√¨nh t∆∞∆°ng t·ª± ƒë∆∞·ª£c th·ª±c hi·ªán ƒë·ªÉ c·∫≠p nh·∫≠t d·ªØ li·ªáu hi·ªán c√≥.

```sql
--T·∫°o UNIQUE ngay khi t·∫°o m·ªõi table
CREATE TABLE [dbo].[categories] (
  [category_id] INT IDENTITY(1,1) PRIMARY KEY NOT NULL, --Kh√≥a ch√≠nh t·ª± tƒÉng
  [category_name] NVARCHAR(50) UNIQUE NOT NULL, -- UNIQUE
  [description] NVARCHAR(500) NULL,
);
GO
```

B·∫°n c≈©ng c√≥ th·ªÉ t·∫°o UNIQUE cho m·ªôt table ƒë√£ t·ªìn t·∫°i

```sql
ALTER TABLE [dbo].[categories]
ADD CONSTRAINT [UQ_categories_category_name] UNIQUE ([category_name]); --UQ_categories_Name l√† t√™n b·∫°n ƒë·∫∑t cho CONTRAINT
GO
```

==> S·ª≠ d·ª•ng ti·∫øp ƒë·∫ßu ng·ªØ `uq_` ƒë·ªÉ nh·∫≠n bi·∫øt ƒë√≥ l√† UNIQUE

**X√≥a UNIQUE Contraint**

```sql
ALTER TABLE table_name
DROP CONSTRAINT uq_constraint_name;

```


### üîπ NOT NULL

Trong l√Ω thuy·∫øt c∆° s·ªü d·ªØ li·ªáu, NULL ƒë·∫°i di·ªán cho th√¥ng tin ch∆∞a bi·∫øt ho·∫∑c thi·∫øu th√¥ng tin. NULL kh√¥ng gi·ªëng nh∆∞ m·ªôt chu·ªói tr·ªëng ho·∫∑c s·ªë 0.

Gi·∫£ s·ª≠ b·∫°n c·∫ßn ch√®n ƒë·ªãa ch·ªâ email c·ªßa m·ªôt li√™n h·ªá v√†o b·∫£ng. B·∫°n c√≥ th·ªÉ y√™u c·∫ßu ƒë·ªãa ch·ªâ email c·ªßa ng∆∞·ªùi ƒë√≥. Tuy nhi√™n, n·∫øu b·∫°n kh√¥ng bi·∫øt ng∆∞·ªùi li√™n h·ªá ƒë√≥ c√≥ ƒë·ªãa ch·ªâ email hay kh√¥ng, b·∫°n c√≥ th·ªÉ ch√®n NULL v√†o c·ªôt ƒë·ªãa ch·ªâ email. Trong tr∆∞·ªùng h·ª£p n√†y, NULL ch·ªâ ra r·∫±ng ƒë·ªãa ch·ªâ email kh√¥ng ƒë∆∞·ª£c bi·∫øt t·∫°i th·ªùi ƒëi·ªÉm ghi.

NULL r·∫•t ƒë·∫∑c bi·ªát. N√≥ kh√¥ng b·∫±ng b·∫•t c·ª© th·ª© g√¨, k·ªÉ c·∫£ ch√≠nh n√≥. Bi·ªÉu th·ª©c NULL = NULL tr·∫£ v·ªÅ NULL v√¨ ƒëi·ªÅu ƒë√≥ c√≥ nghƒ©a l√† hai gi√° tr·ªã ch∆∞a bi·∫øt kh√¥ng ƒë∆∞·ª£c b·∫±ng nhau.

ƒê·ªãnh nghƒ©a NOT NULL ngay khi t·∫°o m·ªõi table

```sql
CREATE TABLE [dbo].[categories] (
  [category_id] INT IDENTITY(1,1) PRIMARY KEY NOT NULL, --Kh√≥a ch√≠nh t·ª± tƒÉng
  [category_name] NVARCHAR(50) UNIQUE NOT NULL, -- UNIQUE
  [description] NVARCHAR(500),
);
GO
```
Ho·∫∑c cho table ƒë√£ t·ªìn t·∫°i

```sql
ALTER TABLE [dbo].[categories]
ALTER COLUMN [name] NVARCHAR(50) UNIQUE NOT NULL;
```


### üîπ DEFAULT

DEFAULT l√† m·ªôt thu·ªôc t√≠nh ƒë∆∞·ª£c s·ª≠ d·ª•ng trong c∆° s·ªü d·ªØ li·ªáu ƒë·ªÉ ƒë·ªãnh nghƒ©a gi√° tr·ªã m·∫∑c ƒë·ªãnh cho m·ªôt c·ªôt khi kh√¥ng c√≥ gi√° tr·ªã n√†o ƒë∆∞·ª£c cung c·∫•p trong qu√° tr√¨nh ch√®n d·ªØ li·ªáu m·ªõi ho·∫∑c c·∫≠p nh·∫≠t d·ªØ li·ªáu trong c·ªôt ƒë√≥.

ƒê·ªãnh nghƒ©a `DEFAULT CONTRAINT` ngay khi t·∫°o m·ªõi Table

price, discount m·∫∑c ƒë·ªãnh = 0

```sql
CREATE TABLE [dbo].[products] (
  [product_id] INT IDENTITY(1,1) PRIMARY KEY NOT NULL, --T·ª± tƒÉng
  [product_name] NVARCHAR(100) NOT NULL,
  [price] DECIMAL(18,2) NOT NULL DEFAULT 0,
  [discount] DECIMAL(4,2) NOT NULL DEFAULT 0,
  [description] NVARCHAR(MAX) NULL,
  [category_id] INT NOT NULL,
  [brand_id] INT NOT NULL,
  CONSTRAINT FK_products_category_id FOREIGN KEY (category_id) 
        REFERENCES categories(category_id), --Kh√≥a ngo·∫°i category_id
  CONSTRAINT FK_products_brand_id FOREIGN KEY (brand_id) 
        REFERENCES brands(brand_id) --Kh√≥a ngo·∫°i brand_id

);
GO

```
V·ªõi ki·ªÉu d·ªØ li·ªáu th·ªùi gian v√≠ d·ª• nh∆∞ ghi nh·∫≠n th·ªùi gian th√™m m·ªõi ƒë∆°n h√†ng `order_date`

V√≠ d·ª•:

```sql
CREATE TABLE [dbo].[orders] (
	[order_id] [int]  NOT NULL,
	[customer_id] [int] NOT NULL,
	[order_status] [tinyint] NOT NULL,
	-- Order status: 1 = Pending; 2 = Processing; 3 = cancel; 4 = Completed
	[order_date] [datetime2] NOT NULL DEFAULT CURRENT_TIMESTAMP,
	[required_date] [datetime2] NOT NULL,
	[shipped_date] [datetime2] NULL,
	[store_id] [int] NOT NULL,
	[staff_id] [int] NOT NULL,
	[order_note] [nvarchar](500) NULL,
	[shipping_address] [nvarchar](500) NULL,
	[shipping_city] [nvarchar](50) NULL,
	[payment_type] [tinyint] NOT NULL,
	-- payment type: 1 = COD; 2 = Credit; 3 = ATM; 4 = Cash
	[order_amount] [decimal](18, 2) NOT NULL
);
GO
```



### üîπ CHECK

Check Contraint l√† m·ªôt lo·∫°i r√†ng bu·ªôc cho ph√©p b·∫°n ch·ªâ ƒë·ªãnh xem c√°c gi√° tr·ªã trong m·ªôt c·ªôt c√≥ ph·∫£i ƒë√°p ·ª©ng m·ªôt y√™u c·∫ßu c·ª• th·ªÉ hay kh√¥ng.

N·∫øu c√°c gi√° tr·ªã v∆∞·ª£t qua qu√° tr√¨nh ki·ªÉm tra, PostgreSQL s·∫Ω ch√®n ho·∫∑c c·∫≠p nh·∫≠t c√°c gi√° tr·ªã n√†y v√†o c·ªôt. N·∫øu kh√¥ng, PostgreSQL s·∫Ω t·ª´ ch·ªëi c√°c thay ƒë·ªïi v√† ƒë∆∞a ra l·ªói vi ph·∫°m r√†ng bu·ªôc.


T·∫°o table  products FULL C√°c CONTRAINT, ngay khi t·∫°o m·ªõi

```sql
CREATE TABLE [dbo].[products] (
  [product_id] INT IDENTITY(1,1) PRIMARY KEY NOT NULL, --T·ª± tƒÉng
  [product_name] NVARCHAR(100) NOT NULL,
  [price] DECIMAL(18,2) DEFAULT 0 CHECK (price >=0),
  [discount] DECIMAL(4,2) DEFAULT 0 NOT NULL CHECK (discount >=0 AND discount <= 70),
  [description] NVARCHAR(MAX) NULL,
  [category_id] INT NOT NULL,
  [brand_id] INT NOT NULL,
  CONSTRAINT FK_products_category_id FOREIGN KEY (category_id) 
        REFERENCES categories(category_id), --Kh√≥a ngo·∫°i category_id
  CONSTRAINT FK_products_brand_id FOREIGN KEY (brand_id) 
        REFERENCES brands(brand_id) --Kh√≥a ngo·∫°i brand_id

);
GO

```

B·∫°n c≈©ng c√≥ th·ªÉ t·∫°o CONTRAINT CHECK cho table ƒë√£ t·ªìn t·∫°i


```sql
-- Create CHECK (price > 0)
ALTER TABLE [dbo].[products]
ADD CONSTRAINT [CK_products_price] CHECK ([price] > 0);
GO

--Create CHECK (discount >= 0 AND discount <= 90)
ALTER TABLE [dbo].[products]
ADD CONSTRAINT [CK_products_discount] CHECK ([discount] >= 0 AND [discount] <= 90);
GO

```

==> S·ª≠ d·ª•ng ti·∫øp ƒë·∫ßu ng·ªØ `ck_` ƒë·ªÉ nh·∫≠n bi·∫øt ƒë√≥ l√† Check

**X√≥a Check Contraint**

```sql
ALTER TABLE table_name
DROP CONSTRAINT check_constraint_name;
```

**T·∫Øt Check Contraint**

C√∫ ph√°p

```sql
ALTER TABLE table_name
NO CHECK CONSTRAINT check_constraint_name;
```

## üíõ K·∫øt Lu·∫≠n

T·ªïng h·ª£p c√°c v·∫•n ƒë·ªÅ tr√™n b·∫°n c√≥ th·ªÉ th·ª±c hi·ªán t·∫°o b·∫£ng, v·ªõi ƒë·∫ßy ƒë·ªß t√≠nh nƒÉng trong l·∫ßn t·∫°o m·ªõi nh∆∞ sau:

- C√≥ Kh√≥a ch√≠nh t·ª± tƒÉng ƒë∆∞·ª£c ƒë·∫∑t t√™n
- C√≥ kh√≥a ngo·∫°i ƒë∆∞·ª£c ƒë·∫∑t t√™n
- C√≥ c√°c contraints ƒë∆∞·ª£c ƒë·∫∑t t√™n


```sql
CREATE TABLE [dbo].[products] (
  [product_id] INT IDENTITY(1,1) NOT NULL, --T·ª± tƒÉng
  [product_name] NVARCHAR(100) NOT NULL,
  [price] DECIMAL(18,2) DEFAULT 0,
  [discount] DECIMAL(4,2) DEFAULT 0,
  [description] NVARCHAR(MAX) NULL,
  [category_id] INT NOT NULL,
  [brand_id] INT NOT NULL,
  -- Kh√≥a ch√≠nh
  CONSTRAINT PK_products_product_id PRIMARY KEY (product_id),
  -- Danh s√°ch kh√≥a ngo·∫°i n·∫øu c√≥
  CONSTRAINT FK_products_category_id FOREIGN KEY (category_id) 
        REFERENCES categories(category_id), --Kh√≥a ngo·∫°i category_id
  CONSTRAINT FK_products_brand_id FOREIGN KEY (brand_id) 
        REFERENCES brands(brand_id), --Kh√≥a ngo·∫°i brand_id
    -- Danh s√°ch c√°c contraints n·∫øu c√≥
    CONSTRAINT [UQ_produtcs_product_name] UNIQUE ([product_name]),
    CONSTRAINT [CK_products_price] CHECK ([price] > 0),
    CONSTRAINT [CK_products_discount] CHECK ([discount] >= 0 AND [discount] <= 90)

);
```
==> M·ª•c ti√™u m·ªçi th·ª© ƒë·ªãnh nghƒ©a ra ph·∫£i c√≥ t√™n r√µ r√†ng ƒë·ªÉ qu·∫£n l√Ω.

